from internnav.configs.trainer.eval import EvalCfg

from .base_encoders import (
    CrossModalEncoder,
    DiffusionPolicy,
    DistancePredictor,
    ImageEncoder,
    ImageEncoderDepth,
    ImageEncoderRgb,
    ImuEncoder,
    ModelCfg,
    PrevActionEncoder,
    ProgressMonitor,
    StateEncoder,
    StopProgressPredictor,
    TextEncoder,
)

rdp_cfg = ModelCfg(
    policy_name='RDP_Policy',
    max_step=200,
    learn_angle=True,
    use_iw=False,
    len_traj_act=4,
    text_encoder=TextEncoder(
        load_model=True,
        max_length=248,
        update_text_encoder=False,
        type='clip-long',
        model_name='clip-long',
        model_path='checkpoints/clip-long/longclip-B.pt',
        num_l_layers=6,
        hidden_size=512,
        vocab_size=50265,
        embedding_size=512,
        sot_token=49406,
        eot_token=49407,
        pad_token=0,
    ),
    image_encoder=ImageEncoder(
        use_stack=False,
        img_stack_nums=4,
        dropout=0.1,
        use_env_drop=True,
        env_drop=0.3,
        rgb=ImageEncoderRgb(
            load_model=True,
            update_rgb_encoder=False,
            model_name='clip-long',
            model_path='checkpoints/clip-long/longclip-B.pt',
            rgb_proj=False,
            feature_dim=768,
            projection_dim=512,
            img_mod='multi_patches_avg_pooling',
            multi_patches_num=5,
        ),
        depth=ImageEncoderDepth(
            load_model=True,
            update_depth_encoder=False,
            bottleneck='resnet',
            feature_dim=768,
            projection_dim=512,
            cnn_type='VlnResnetDepthEncoder',
            output_size=128,
            ddppo_checkpoint='checkpoints/ddppo-models/gibson-4plus-mp3d-train-val-test-resnet50.pth',
            backbone='resnet50',
        ),
    ),
    cross_modal_encoder=CrossModalEncoder(
        load_model=False,
        input_type=3,
        num_x_layers=2,
        hidden_size=512,
        num_attention_heads=8,
        txt_to_img=True,
        txt_to_img_layer=2,
    ),
    state_encoder=StateEncoder(
        hidden_size=512,
        rnn_type='GRU',
        num_recurrent_layers=1,
        rgb_depth_embed_method='flat',
        use_dropout=False,
        dropout_rate=0.2,
    ),
    diffusion_policy=DiffusionPolicy(
        use=True,
        type='transformer',
        scheduler='DDPM',
        pred_type='epsilon',
        clip_sample=True,
        use_cls_free_guidance=True,
        cls_free_guidance_scale=1.5,
        cls_mask_ratio=0.25,
        random_mask_rgb=True,
        random_mask_instr=True,
        cls_mask_method='mask_token',
        action_stats={'min': [-0.25, -0.25, -0.27], 'max': [0.25, 0.25, 0.27]},
        metric_waypoint_spacing=1,
        num_diffusion_iters=20,
        transformer_n_cond_layers=1,
        transformer_n_layers=3,
        transformer_encoding_size=512,
        transformer_p_drop_emb=0.2,
        txt_len=80,
        waypoint_spacing=1,
        len_traj_pred=8,
    ),
    distance_predictor=DistancePredictor(
        use=False,
        normalize=False,
    ),
    imu_encoder=ImuEncoder(
        input_size=3,
        encoding_size=64,
        use=True,
        to_local_coords=True,
    ),
    prev_action_encoder=PrevActionEncoder(
        encoding_size=64,
        type='continuous',
    ),
    progress_monitor=ProgressMonitor(
        use=True,
        concat_state_txt=True,
    ),
    stop_progress_predictor=StopProgressPredictor(
        use=True,
        concat_state_txt=True,
        type='continuous',
        loss_alpha=10,
    ),
    eval=EvalCfg(
        use_ckpt_config=False,
        save_results=True,
        split=['val_unseen'],
        episode_count=-1,
        max_steps=195,
        train_eval_interval=100,
        action='discrete',
        re_eval=False,
        load_eval_subset=True,
        success_distance=3.0,
        stop_x_threshold=0.015,
        stop_y_threshold=0.015,
        stop_yaw_threshold=0.05,
        rotation_threshold=0.01,
        use_dynamic_len_traj_act=False,
        min_len_traj_act=3,
        max_len_traj_act=8,
        min_displacement=0.15,
        distance_threshold=1.5,
        num_sample=1,
        auto_remove=False,
        start_eval_epoch=-1,
        stop_mode='stop_progress',
        pm_threshold=0.9,
        stop_progress_threshold=0.85,
        step_interval=80,
        len_traj_act=4,
    ),
)


rdp_eval_cfg = ModelCfg(
    policy_name='RDP_Policy',
    max_step=200,
    learn_angle=True,
    use_iw=False,
    len_traj_act=4,
    text_encoder=TextEncoder(
        load_model=True,
        max_length=248,
        update_text_encoder=False,
        type='clip-long',
        model_name='clip-long',
        model_path='checkpoints/clip-long/longclip-B.pt',
        num_l_layers=6,
        hidden_size=512,
        vocab_size=50265,
        embedding_size=512,
        sot_token=49406,
        eot_token=49407,
        pad_token=0,
    ),
    image_encoder=ImageEncoder(
        use_stack=False,
        img_stack_nums=4,
        dropout=0.1,
        use_env_drop=True,
        env_drop=0.3,
        rgb=ImageEncoderRgb(
            load_model=True,
            update_rgb_encoder=False,
            model_name='clip-long',
            model_path='checkpoints/clip-long/longclip-B.pt',
            rgb_proj=False,
            feature_dim=768,
            projection_dim=512,
            img_mod='multi_patches_avg_pooling',
            multi_patches_num=5,
        ),
        depth=ImageEncoderDepth(
            load_model=True,
            update_depth_encoder=False,
            bottleneck='resnet',
            feature_dim=768,
            projection_dim=512,
            cnn_type='VlnResnetDepthEncoder',
            output_size=128,
            ddppo_checkpoint='checkpoints/ddppo-models/gibson-4plus-mp3d-train-val-test-resnet50.pth',
            backbone='resnet50',
        ),
    ),
    cross_modal_encoder=CrossModalEncoder(
        load_model=False,
        input_type=3,
        num_x_layers=2,
        hidden_size=512,
        num_attention_heads=8,
        txt_to_img=True,
        txt_to_img_layer=2,
    ),
    state_encoder=StateEncoder(
        hidden_size=512,
        rnn_type='GRU',
        num_layers=1,
        rgb_depth_embed_method='flat',
        use_dropout=False,
        dropout_rate=0.2,
    ),
    diffusion_policy=DiffusionPolicy(
        use=True,
        type='transformer',
        scheduler='DDPM',
        pred_type='epsilon',
        clip_sample=True,
        use_cls_free_guidance=True,
        cls_free_guidance_scale=1.5,
        cls_mask_ratio=0.25,
        random_mask_rgb=True,
        random_mask_instr=True,
        cls_mask_method='mask_token',
        action_stats={'min': [-0.25, -0.25, -0.27], 'max': [0.25, 0.25, 0.27]},
        metric_waypoint_spacing=1,
        num_diffusion_iters=20,
        transformer_n_cond_layers=1,
        transformer_n_layers=3,
        transformer_encoding_size=512,
        transformer_p_drop_emb=0.2,
        txt_len=80,
        waypoint_spacing=1,
        len_traj_pred=8,
    ),
    distance_predictor=DistancePredictor(
        use=False,
        normalize=False,
    ),
    imu_encoder=ImuEncoder(
        input_size=3,
        encoding_size=64,
        use=True,
        to_local_coords=True,
    ),
    prev_action_encoder=PrevActionEncoder(
        encoding_size=64,
        type='continuous',
    ),
    progress_monitor=ProgressMonitor(
        use=True,
        concat_state_txt=True,
    ),
    stop_progress_predictor=StopProgressPredictor(
        use=True,
        concat_state_txt=True,
        type='continuous',
        loss_alpha=10,
    ),
)
